<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NovaSeek</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg: #ffffff;
            --surface: #ffffff;
            --muted: #6b7278;
            --text: #0b0d10;
            --brand: #4285f4;
            --accent: #5985E1;
            --shadow: rgba(0,0,0,0.08);
            --card-border: #e6e7e8;
            --chip-bg: #fff;
            --chip-border: #e6e7e8;
            --radius-lg: 14px;
            --radius-pill: 999px;
            --glass: rgba(255,255,255,0.85);
            --glass-dark: rgba(0,0,0,0.5);
            --success: #34a853;
            --danger: #ea4335;
            --transition: 200ms ease;
            --max-width: 980px;
            --search-height: 56px;
            --card-padding: 16px;
        }
        body.dark{
            --bg: #0b0c10;
            --surface: #111215;
            --muted: #b0b3b6;
            --text: #eef0f2;
            --chip-bg: #111215;
            --chip-border: #26282b;
            --card-border: #222428;
            --glass: rgba(10,10,12,0.7);
        }
        *{ box-sizing:border-box }
        html,body{ height:100% }
        body{
            margin:0;
            padding:0;
            font-family: "Roboto", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background:var(--bg);
            color:var(--text);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            display:flex;
            flex-direction:column;
            align-items:center;
            transition: background var(--transition), color var(--transition);
        }
        .header {
            width:100%;
            max-width:var(--max-width);
            padding:16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }
        .brand {
            display:flex;
            gap:12px;
            align-items:center;
        }
        .brand .dot {
            width:14px;
            height:14px;
            border-radius:50%;
            background: linear-gradient(135deg,var(--brand),#8ab4f8);
            box-shadow:0 0 12px rgba(66,133,244,0.18);
        }
        .brand .logo {
            font-family:'Orbitron',sans-serif;
            font-weight:700;
            font-size:22px;
            letter-spacing:.06em;
            background: linear-gradient(90deg,#8ab4f8,#a0c3ff);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }
        #authBtn{
            min-width:44px;
            height:44px;
            border-radius:50%;
            border:1px solid var(--card-border);
            background:var(--chip-bg);
            color:var(--text);
            display:grid;
            place-items:center;
            cursor:pointer;
            font-weight:700;
            box-shadow:0 4px 12px var(--shadow);
            transition: transform .06s ease, background var(--transition), border-color var(--transition);
        }
        #authBtn:hover{ transform:scale(.98); border-color:rgba(0,0,0,0.12); }
        #authBtn:active{ transform:scale(.96); }
        .auth-user {
            display:flex;
            gap:8px;
            align-items:center;
        }
        .user-badge{
            min-width:44px;
            height:44px;
            border-radius:50%;
            display:grid;
            place-items:center;
            font-weight:700;
            color:var(--chip-bg);
            background: linear-gradient(135deg,var(--brand),#5a8ef6);
            box-shadow:0 6px 18px rgba(90,142,246,0.12);
        }
        .container{
            width:100%;
            max-width:var(--max-width);
            padding:0 16px 80px 16px;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:18px;
        }
        .hero {
            margin-top:6vh;
            text-align:center;
        }
        .wordmark{
            font-family:'Orbitron',sans-serif;
            font-weight:700;
            font-size:48px;
            background: linear-gradient(90deg,#8ab4f8,#a0c3ff);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            letter-spacing:.06em;
            margin-bottom:6px;
        }
        .subtitle{
            color:var(--muted);
            font-size:14px;
            margin-top:4px;
        }
        .search-wrap{
            width:100%;
            max-width:720px;
            display:flex;
            flex-direction:column;
            gap:8px;
            align-items:center;
        }
        .search{
            width:100%;
            display:flex;
            gap:10px;
            align-items:center;
            padding:10px;
            border-radius:999px;
            background:var(--surface);
            border:1px solid var(--card-border);
            box-shadow:0 6px 18px var(--shadow);
            transition: box-shadow .18s, border-color .18s, background .2s;
            height:var(--search-height);
            position:relative;
        }
        .search:focus-within{ box-shadow:0 12px 36px rgba(0,0,0,0.08); border-color:rgba(0,0,0,0.06); }
        .search input[type="text"]{
            flex:1;
            border:0;
            outline:0;
            background:transparent;
            color:var(--text);
            font-size:16px;
            padding:8px 6px;
        }
        .icon-btn{
            width:44px;
            height:44px;
            border-radius:50%;
            border:1px solid var(--card-border);
            background:var(--chip-bg);
            display:grid;
            place-items:center;
            cursor:pointer;
            transition: transform .06s, background var(--transition), border-color var(--transition);
        }
        .icon-btn:hover{ transform:scale(.98); }
        .chips{
            width:100%;
            max-width:720px;
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            justify-content:center;
            padding:6px 6px;
        }
        .chips .chip{
            padding:8px 12px;
            border-radius:999px;
            background:var(--chip-bg);
            border:1px solid var(--chip-border);
            cursor:pointer;
            transition: background .15s, transform .08s;
            color:var(--text);
            font-size:14px;
        }
        .chips .chip:hover{ background:rgba(66,133,244,0.06); transform:translateY(-1px); }
        .ai-suggest {
            position:absolute;
            top:calc(var(--search-height) + 8px);
            left:0;
            width:100%;
            max-height:260px;
            overflow:auto;
            border-radius:12px;
            background:var(--surface);
            border:1px solid var(--card-border);
            box-shadow:0 10px 30px rgba(0,0,0,0.08);
            z-index:1200;
            display:none;
        }
        .ai-suggest.visible{ display:block; }
        .ai-suggest ul{ list-style:none; margin:0; padding:6px 0; }
        .ai-suggest li{
            padding:10px 12px;
            cursor:pointer;
            color:var(--text);
        }
        .ai-suggest li:hover{ background:rgba(66,133,244,0.06); }
        .results{
            width:100%;
            max-width:720px;
            display:flex;
            flex-direction:column;
            gap:16px;
            margin-top:6px;
            align-items:stretch;
        }
        .result-card{
            display:flex;
            gap:14px;
            padding:var(--card-padding);
            border-radius:var(--radius-lg);
            background:var(--surface);
            border:1px solid var(--card-border);
            box-shadow:0 8px 28px rgba(0,0,0,0.06);
            transition: transform .12s ease, box-shadow .12s ease, background .2s;
        }
        .result-card:hover{ transform:translateY(-2px); box-shadow:0 12px 36px rgba(0,0,0,0.1); }
        .result-thumb{
            width:120px;
            height:80px;
            border-radius:10px;
            background:linear-gradient(180deg,#f2f2f2,#e8e8e8);
            flex-shrink:0;
            display:block;
            object-fit:cover;
            border:1px solid var(--card-border);
        }
        .result-body{ flex:1; display:flex; flex-direction:column; gap:6px; }
        .result-title{ font-size:18px; margin:0; font-weight:700; color:var(--text); }
        .result-desc{ font-size:14px; color:var(--muted); margin:0; line-height:1.45; }
        .result-meta{ font-size:12px; color:var(--muted); }
        .result-actions{ margin-top:8px; display:flex; gap:8px; align-items:center; }
        .btn-small{
            padding:8px 12px;
            border-radius:999px;
            border:1px solid var(--card-border);
            background:var(--chip-bg);
            cursor:pointer;
            font-weight:600;
            font-size:13px;
        }
        .side-panel{
            width:320px;
            display:flex;
            flex-direction:column;
            gap:12px;
        }
        .panel {
            padding:12px;
            border-radius:12px;
            background:var(--surface);
            border:1px solid var(--card-border);
            box-shadow:0 8px 28px rgba(0,0,0,0.06);
        }
        .panel h4{ margin:0 0 8px 0; font-size:16px; color:var(--text); }
        .list .row{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px; border-radius:10px; cursor:pointer; transition: background .12s; background:transparent; }
        .list .row:hover{ background:rgba(66,133,244,0.06); }
        .list .rank{ width:28px; height:28px; border-radius:50%; display:grid; place-items:center; background:var(--chip-bg); border:1px solid var(--card-border); }
        .footer {
            position:fixed;
            left:12px;
            bottom:10px;
            z-index:20;
            font-size:13px;
            color:var(--muted);
            background:var(--glass);
            padding:6px 10px;
            border-radius:10px;
            border:1px solid var(--card-border);
        }
        @media (max-width:1000px){ .side-panel{ width:260px; } }
        @media (max-width:860px){
            .cols{ grid-template-columns: 1fr; gap:12px; }
            .side-panel{ width:100%; }
            .search{ height:52px; }
        }
        @media (max-width:520px){
            .wordmark{ font-size:36px; }
            .search{ padding:8px; }
            .chips{ padding:4px; }
        }
    </style>
</head>
<body>
<header class="header" role="banner">
    <div class="brand" aria-hidden="false">
        <div class="dot" aria-hidden="true"></div>
        <div class="logo">NovaSeek</div>
    </div>
    <div id="authArea" aria-live="polite">
        <button id="authBtn" aria-label="登入或管理帳戶" title="登入 / 管理帳戶">登入</button>
    </div>
</header>
<div id="backdrop" aria-hidden="true"></div>
<div id="authPopup" aria-modal="true" role="dialog" aria-hidden="true"></div>
<main class="container" role="main">
    <section class="hero" aria-labelledby="hero-title">
        <h1 id="hero-title" class="wordmark">NovaSeek</h1>
        <div class="subtitle">智能搜尋‑AI 建議、你的收藏與統計</div>
    </section>
    <section class="search-wrap" aria-label="搜尋區">
        <div class="search" id="searchBox">
            <input id="searchInput" type="text" placeholder="在 NovaSeek 上搜尋（按 Enter 或點按放大鏡）" autocomplete="off" aria-label="搜尋輸入" />
            <button class="icon-btn" id="btnSearch" title="搜尋" aria-label="搜尋按鈕">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#5985E1"><path d="M765-144 526-383q-30 22-65.79 34.5-35.79 12.5-76.18 12.5Q284-336 214-406t-70-170q0-100 70-170t170-70q100 0 170 70t70 170.03q0 40.39-12.5 76.18Q599-464 577-434l239 239-51 51ZM384-408q70 0 119-49t49-119q0-70-49-119t-119-49q-70 0-119 49t-49 119q0 70 49 119t119 49Z"/></svg>
            </button>
            <button class="icon-btn" id="btnMic" title="語音搜尋" aria-label="語音搜尋">
                <svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#5985E1"><path d="M480-384q-50 0-85-35t-35-85v-240q0-50 35-85t85-35q50 0 85 35t35 85v240q0 50-35 85t-85 35Zm0-240Zm-36 480v-99q-98.8-13.1-163.4-87.05Q216-404 216-504h72q0 79.68 56.23 135.84 56.22 56.16 136 56.16Q560-312 616-368.16q56-56.16 56-135.84h72q0 100-64.6 173.95Q614.8-256.1 516-243v99h-72Zm36-312q20.4 0 34.2-13.8Q528-483.6 528-504v-240q0-20.4-13.8-34.2Q500.4-792 480-792q-20.4 0-34.2 13.8Q432-764.4 432-744v240q0 20.4 13.8 34.2Q459.6-456 480-456Z"/></svg>
            </button>
            <div class="ai-suggest" id="aiSuggest" role="listbox" aria-label="建議清單"></div>
        </div>
        <div class="chips" id="chips" role="list" aria-label="熱門或建議關鍵字"></div>
    </section>
    <div class="cols" style="width:100%;max-width:var(--max-width);display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:6px;">
        <div>
            <div class="results" id="results" role="region" aria-live="polite" aria-label="搜尋結果"></div>
        </div>
        <aside class="side-panel" aria-label="側邊功能">
            <div class="panel" id="panelTrending" aria-live="polite">
                <h4>熱門搜尋</h4>
                <div class="list" id="trendingList" role="list"></div>
            </div>
            <div class="panel" id="panelRecent" aria-live="polite">
                <h4>你的最近搜尋</h4>
                <div class="list" id="recentList" role="list"></div>
            </div>
        </aside>
    </div>
</main>
<div class="footer" aria-hidden="false">Copyright © 2025 NovaSeek 保留一切權利。</div>
<button id="modeBtn" title="切換深淺模式" aria-pressed="false" style="position:fixed;right:20px;bottom:20px;z-index:1200;padding:10px 15px;border-radius:12px;border:1px solid var(--card-border);background:var(--surface);color:var(--text);cursor:pointer;font-weight:500;">自訂 NovaSeek</button>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
    // ----------------------------------------------------
    // Firebase & 環境設定
    // ----------------------------------------------------
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyA7K4x1Di_xUaVt7MF08LfumJxc10dqa3c",
        authDomain: "sample-firebase-ai-app-df21b.firebaseapp.com",
        projectId: "sample-firebase-ai-app-df21b",
        storageBucket: "sample-firebase-ai-app-df21b",
        messagingSenderId: "762970139210",
        appId: "1:762970139210:web:149e9ab5e9593a484cd4b3"
    };
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ----------------------------------------------------
    // DOM 元素與狀態
    // ----------------------------------------------------
    const authArea = document.getElementById('authArea');
    const authBtn = document.getElementById('authBtn');
    const searchBox = document.getElementById('searchBox');
    const searchInput = document.getElementById('searchInput');
    const btnSearch = document.getElementById('btnSearch');
    const btnMic = document.getElementById('btnMic');
    const aiSuggest = document.getElementById('aiSuggest');
    const chipsDiv = document.getElementById('chips');
    const resultsDiv = document.getElementById('results');
    const trendingList = document.getElementById('trendingList');
    const recentList = document.getElementById('recentList');
    const modeBtn = document.getElementById('modeBtn');

    let currentUser = null;
    let aiLocalCache = {};
    let localTrendingCounts = {};
    let currentSuggestList = [];
    let selectedSuggestIndex = -1;

    // ----------------------------------------------------
    // 工具函數
    // ----------------------------------------------------
    function escapeHtml(str){
        if(!str) return '';
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#39;');
    }

    function timeAgo(timestamp){
        if(!timestamp) return '';
        const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
        let interval = Math.floor(seconds / 31536000);
        if(interval >= 1) return interval + ' 年前';
        interval = Math.floor(seconds / 2592000);
        if(interval >= 1) return interval + ' 個月前';
        interval = Math.floor(seconds / 86400);
        if(interval >= 1) return interval + ' 天前';
        interval = Math.floor(seconds / 3600);
        if(interval >= 1) return interval + ' 小時前';
        interval = Math.floor(seconds / 60);
        if(interval >= 1) return interval + ' 分鐘前';
        return '剛剛';
    }

    // ----------------------------------------------------
    // 登入與使用者狀態 (Auth UI 邏輯已簡化)
    // ----------------------------------------------------
    function parseRedirectLogin(){
        const params = new URLSearchParams(window.location.search);
        const email = params.get('email');
        const name = params.get('name');
        if(email){
            const u = { email: email, name: name || email.split('@')[0] };
            localStorage.setItem('novaseek_user', JSON.stringify(u));
            currentUser = u;
            const clean = window.location.pathname;
            window.history.replaceState({}, document.title, clean);
        } else {
            const su = localStorage.getItem('novaseek_user');
            if(su){
                try{ currentUser = JSON.parse(su); }catch(e){ currentUser = null; }
            }
        }
        renderAuthUI();
    }

    function renderAuthUI(){
        authArea.innerHTML = '';
        if(currentUser){
            const wrapper = document.createElement('div');
            wrapper.className = 'auth-user';
            const badge = document.createElement('div');
            badge.className = 'user-badge';
            badge.textContent = (currentUser.name && currentUser.name[0]) ? currentUser.name[0].toUpperCase() : (currentUser.email?currentUser.email[0].toUpperCase():'U');
            const logoutBtn = document.createElement('button');
            logoutBtn.className = 'icon-btn';
            logoutBtn.style.width = 'auto';
            logoutBtn.style.borderRadius = '12px';
            logoutBtn.style.padding = '8px 12px';
            logoutBtn.textContent = '登出';
            logoutBtn.addEventListener('click', ()=>{
                localStorage.removeItem('novaseek_user');
                currentUser = null;
                renderAuthUI();
                updateRecentListUI();
            });
            wrapper.appendChild(badge);
            wrapper.appendChild(logoutBtn);
            authArea.appendChild(wrapper);
        } else {
            const btn = document.createElement('button');
            btn.id = 'authBtn2';
            btn.textContent = '登入';
            btn.className = 'icon-btn';
            btn.style.width = 'auto';
            btn.style.borderRadius = '12px';
            btn.style.padding = '8px 12px';
            btn.addEventListener('click', ()=> {
                const redirectUrl = encodeURIComponent(window.location.origin + window.location.pathname);
                window.location.href = `https://accounts.novaseek.org/?redirect=${redirectUrl}`;
            });
            authArea.appendChild(btn);
        }
    }

    // ----------------------------------------------------
    // AI 建議邏輯 (連接 Node.js 後端)
    // ----------------------------------------------------
    function generateLocalAISuggestions(query){
        if(!query) return [];
        const base = query.trim();
        return [
            `${base} 是什麼`,
            `${base} 關於`,
            `${base} 教學`,
            `最新 ${base} 資訊`,
            `${base} 下載`,
            `${base} 免費資源`,
            `${base} vs 競品`,
            `${base} 好用嗎`,
            `${base} 範例`
        ].slice(0, 5);
    }

    async function fetchAIFromAPI(query){
        if(aiLocalCache[query]) return aiLocalCache[query];
        const localSuggestions = generateLocalAISuggestions(query);
        
        try{
            // 連接到 Node.js 後端代理服務
            const response = await fetch('http://localhost:3000/api/ai-suggestions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query }),
            });
            if(!response.ok) throw new Error('Proxy server error or not running');
            const data = await response.json();
            
            // 合併本地備用建議與來自真實後端的建議
            const remoteSuggestions = data.suggestions || [];
            const merged = [...new Set([...localSuggestions, ...remoteSuggestions])].slice(0, 10);
            aiLocalCache[query] = merged;
            return merged;
        }catch(e){
            // console.warn('Backend connection failed, using local fallback.', e);
            return localSuggestions;
        }
    }

    function renderAISuggestions(suggestions){
        currentSuggestList = suggestions || [];
        selectedSuggestIndex = -1;
        aiSuggest.innerHTML = '';
        if(!suggestions || suggestions.length === 0){
            aiSuggest.classList.remove('visible');
            aiSuggest.style.display = 'none';
            return;
        }
        const ul = document.createElement('ul');
        suggestions.forEach((s, idx) => {
            const li = document.createElement('li');
            li.setAttribute('role','option');
            li.setAttribute('aria-selected','false');
            li.tabIndex = 0;
            li.innerHTML = escapeHtml(s);
            li.addEventListener('mouseenter', ()=> { selectedSuggestIndex = idx; updateSuggestHighlight(); });
            li.addEventListener('mouseleave', ()=> { selectedSuggestIndex = -1; updateSuggestHighlight(); });
            li.addEventListener('click', ()=> { selectSuggestion(idx); });
            ul.appendChild(li);
        });
        aiSuggest.appendChild(ul);
        aiSuggest.classList.add('visible');
        aiSuggest.style.display = 'block';
    }

    function updateSuggestHighlight(){
        const lis = aiSuggest.querySelectorAll('li');
        lis.forEach((li, i) => {
            if(i === selectedSuggestIndex){
                li.style.background = 'rgba(66,133,244,0.06)';
                li.setAttribute('aria-selected','true');
            } else {
                li.style.background = 'transparent';
                li.setAttribute('aria-selected','false');
            }
        });
    }

    function selectSuggestion(idx){
        const s = currentSuggestList[idx];
        if(!s) return;
        searchInput.value = s;
        redirectToSearch(s);
        aiSuggest.classList.remove('visible');
        aiSuggest.style.display = 'none';
    }

    // ----------------------------------------------------
    // 語音搜尋邏輯 (Web Speech API)
    // ----------------------------------------------------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    function startVoiceSearch() {
        if (!SpeechRecognition) {
            alert('抱歉，您的瀏覽器目前不支援語音搜尋功能。建議使用 Chrome 或 Edge。');
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-Hant'; 
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        // 視覺回饋：變更麥克風按鈕狀態
        btnMic.style.borderColor = 'var(--brand)';
        btnMic.style.boxShadow = '0 0 10px rgba(66, 133, 244, 0.4)';
        btnMic.style.background = 'rgba(66, 133, 244, 0.1)';
        btnMic.title = '正在聽取語音... 點擊停止';
        btnMic.querySelector('svg').style.fill = 'var(--brand)';

        recognition.onresult = function(event) {
            const speechResult = event.results[0][0].transcript;
            searchInput.value = speechResult;
            redirectToSearch(speechResult);
        };

        recognition.onend = function() {
            // 結束後恢復按鈕狀態
            btnMic.style.borderColor = 'var(--card-border)';
            btnMic.style.boxShadow = 'none';
            btnMic.style.background = 'var(--chip-bg)';
            btnMic.title = '語音搜尋';
            btnMic.querySelector('svg').style.fill = 'var(--accent)';
        };

        recognition.onerror = function(event) {
            // 錯誤時顯示紅色警告
            btnMic.style.borderColor = 'var(--danger)'; 
            btnMic.title = '辨識失敗';
            btnMic.querySelector('svg').style.fill = 'var(--danger)';
            setTimeout(recognition.onend, 1500); 
        };

        try {
            recognition.start();
        } catch (e) {
            recognition.onend();
        }
    }
    btnMic.addEventListener('click', startVoiceSearch);

    // ----------------------------------------------------
    // 搜尋與數據記錄
    // ----------------------------------------------------
    function redirectToSearch(q){
        if(!q || !q.trim()) return;
        const query = q.trim();
        recordSearch(query).catch(err => console.warn('recordSearch error', err));
        const searchUrl = `https://www.novaseek.org/search?q=${encodeURIComponent(query)}`;
        resultsDiv.innerHTML = `<div class="result-card" style="justify-content:center;align-items:center;min-height:80px;"><div style="color:var(--muted)">正在導向 NovaSeek 官方搜尋頁面…</div></div>`;
        window.location.href = searchUrl;
    }

    async function recordSearch(query){
        try{
            const localList = JSON.parse(localStorage.getItem('novaseek_local_searches') || '[]');
            localList.unshift({ q: query, ts: Date.now() });
            localList.splice(200);
            localStorage.setItem('novaseek_local_searches', JSON.stringify(localList));
        }catch(e){
            // console.warn('local save fail', e);
        }
        if(currentUser && currentUser.email){
            try{
                const docRef = db.collection('searchRecords').doc();
                await docRef.set({
                    q: query,
                    uid: currentUser.email,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
            }catch(e){
                // console.error('Firestore record fail', e);
            }
        }
        updateTrendingCounts(query);
    }

    async function updateTrendingCounts(query){
        query = query.toLowerCase().trim();
        if(localTrendingCounts[query]){
            localTrendingCounts[query] += 1;
        } else {
            localTrendingCounts[query] = 1;
        }
        
        // 僅更新 UI，不再進行遠端 Firestore 事務操作 (簡化流程)
        updateTrendingUI();
        updateRecentListUI();
    }

    function updateTrendingUI(){
        trendingList.innerHTML = '';
        const localTrends = Object.entries(localTrendingCounts).sort(([, a], [, b]) => b - a).slice(0, 5);
        localTrends.forEach(([q, count], index) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.setAttribute('role','listitem');
            row.addEventListener('click', ()=> redirectToSearch(q));
            const rank = document.createElement('div');
            rank.className = 'rank';
            rank.textContent = index + 1;
            const qText = document.createElement('div');
            qText.style.flex = 1;
            qText.textContent = escapeHtml(q);
            const countText = document.createElement('div');
            countText.style.fontSize = '12px';
            countText.style.color = 'var(--muted)';
            countText.textContent = `${count} 次`;
            row.appendChild(rank);
            row.appendChild(qText);
            row.appendChild(countText);
            trendingList.appendChild(row);
        });
        if(localTrends.length === 0){
            trendingList.innerHTML = `<div style="padding:10px;font-size:14px;color:var(--muted);">目前沒有熱門搜尋。</div>`;
        }
    }
    
    function updateRecentListUI(){
        recentList.innerHTML = '';
        const localRecent = JSON.parse(localStorage.getItem('novaseek_local_searches') || '[]');
        const uniqueRecent = [...new Map(localRecent.map(item => [item.q, item])).values()].slice(0, 5);
        uniqueRecent.forEach(({ q, ts }, index) => {
            const row = document.createElement('div');
            row.className = 'row';
            row.setAttribute('role','listitem');
            row.addEventListener('click', ()=> redirectToSearch(q));
            const qText = document.createElement('div');
            qText.style.flex = 1;
            qText.textContent = escapeHtml(q);
            const timeText = document.createElement('div');
            timeText.style.fontSize = '12px';
            timeText.style.color = 'var(--muted)';
            timeText.textContent = timeAgo(ts);
            row.appendChild(qText);
            row.appendChild(timeText);
            recentList.appendChild(row);
        });
        if(uniqueRecent.length === 0){
            recentList.innerHTML = `<div style="padding:10px;font-size:14px;color:var(--muted);">開始搜尋以查看你的紀錄。</div>`;
        }
    }

    function renderInitialChips(){
        const initialKeywords = [
        
        ];
        chipsDiv.innerHTML = '';
        initialKeywords.forEach(keyword => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = keyword;
            chip.addEventListener('click', ()=> redirectToSearch(keyword));
            chipsDiv.appendChild(chip);
        });
    }

    function toggleDarkMode(){
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem('novaseek_mode', isDark ? 'dark' : 'light');
        modeBtn.setAttribute('aria-pressed', isDark);
        modeBtn.textContent = isDark ? '切換亮色模式' : '切換深色模式';
    }

    function loadModePreference(){
        const savedMode = localStorage.getItem('novaseek_mode');
        if(savedMode === 'dark'){
            document.body.classList.add('dark');
            modeBtn.setAttribute('aria-pressed', 'true');
            modeBtn.textContent = '切換亮色模式';
        } else {
            modeBtn.textContent = '切換深色模式';
        }
    }
    modeBtn.addEventListener('click', toggleDarkMode);

    // ----------------------------------------------------
    // 事件監聽與初始化
    // ----------------------------------------------------
    let suggestTimer = null;
    searchInput.addEventListener('input', (e) => {
        const v = e.target.value.trim();
        if(suggestTimer) clearTimeout(suggestTimer);
        if(!v){
            aiSuggest.classList.remove('visible');
            aiSuggest.style.display = 'none';
            currentSuggestList = [];
            selectedSuggestIndex = -1;
            return;
        }
        suggestTimer = setTimeout(async () => {
            const local = generateLocalAISuggestions(v);
            renderAISuggestions(local);
            try{
                const remote = await fetchAIFromAPI(v);
                const merged = [...new Set([...local, ...remote])].slice(0, 10);
                renderAISuggestions(merged);
            }catch(err){
            }
        }, 180);
    });

    searchInput.addEventListener('keydown', async (e) => {
        if(!currentSuggestList.length && e.key !== 'Enter') return;

        if(e.key === 'ArrowDown'){
            e.preventDefault();
            selectedSuggestIndex = (selectedSuggestIndex + 1) % currentSuggestList.length;
            updateSuggestHighlight();
        } else if(e.key === 'ArrowUp'){
            e.preventDefault();
            selectedSuggestIndex = (selectedSuggestIndex - 1 + currentSuggestList.length) % currentSuggestList.length;
            updateSuggestHighlight();
        } else if(e.key === 'Enter'){
            if(selectedSuggestIndex >= 0){
                e.preventDefault();
                selectSuggestion(selectedSuggestIndex);
            } else {
                e.preventDefault();
                redirectToSearch(searchInput.value);
            }
        } else if(e.key === 'Escape'){
            aiSuggest.classList.remove('visible');
            aiSuggest.style.display = 'none';
            selectedSuggestIndex = -1;
        }
    });

    document.addEventListener('click', (e) => {
        if(!searchBox.contains(e.target)){
            aiSuggest.classList.remove('visible');
            aiSuggest.style.display = 'none';
        }
    });
    
    btnSearch.addEventListener('click', () => {
        redirectToSearch(searchInput.value);
    });

    function initializeApp(){
        parseRedirectLogin();
        loadModePreference();
        renderInitialChips();
        updateRecentListUI();
        updateTrendingUI();
    }
    initializeApp();
</script>
</body>
</html>